<!DOCTYPE html>
<html>
<head>
    <title>Import Companionships</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; }
        .navbar { background-color: #343a40; color: white; padding: 10px; display: flex; justify-content: flex-start; }
        .navbar a { color: white; text-decoration: none; margin: 0 15px; }
        .navbar a:hover { text-decoration: underline; }
        .content { padding: 20px; }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="{{ url_for('admin') }}">Calendar</a>
        <a href="{{ url_for('manage_districts') }}">Manage Districts</a>
        <a href="{{ url_for('import_companionships') }}">Import Companionships</a>
        <a href="{{ url_for('send_all_notifications') }}">Send Notifications</a>
    </div>
    
    <div class="content">
        <h1 class="mb-4">Import Companionships from LCR</h1>
        
        <div class="alert alert-info">
            <strong>Note:</strong> This will scrape companionship data from the LDS Church's Leader and Clerk Resources (LCR) ministering page. 
            You must have proper authorization to access this data. The scraping process may take several minutes.
            <br><br>
            <strong>Debug Mode:</strong> The first run will save the page HTML to <code>debug_page.html</code> for inspection. 
            If no data is found, check this file to see the actual page structure and update the CSS selectors in the code.
            Run <code>python debug_scraper.py</code> to analyze the saved HTML and get suggestions for selectors.
        </div>
        
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">LCR Login Credentials</h5>
                    </div>
                    <div class="card-body">
                        <form id="importForm" method="POST">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username:</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password:</label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="submitBtn">Start Import</button>
                        </form>
                        
                        <!-- Progress Section -->
                        <div id="progressSection" class="mt-4" style="display: none;">
                            <h5>Import Progress</h5>
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                            </div>
                            <div id="progressMessage" class="alert alert-info">Initializing...</div>
                            <div id="progressStats" class="small text-muted"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let progressInterval;
        let progressId;
        
        document.getElementById('importForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = document.getElementById('submitBtn');
            const progressSection = document.getElementById('progressSection');
            
            // Disable form and show progress
            submitBtn.disabled = true;
            submitBtn.textContent = 'Importing...';
            progressSection.style.display = 'block';
            
            console.log('üöÄ Starting companionship import...');
            
            // Submit form via fetch
            fetch('/admin/import_companionships', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.progress_id) {
                    console.log(`üìä Progress ID: ${data.progress_id}`);
                    startProgressPolling(data.progress_id);
                } else {
                    console.error('‚ùå No progress ID in response:', data);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Start Import';
                    progressSection.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('‚ùå Network error:', error);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Start Import';
                progressSection.style.display = 'none';
            });
            
            // Start polling for progress
            // The server returns a progress ID that we use to track the background process
        });
        
        function startProgressPolling(progressId) {
            console.log('üìä Starting progress monitoring...');
            
            progressInterval = setInterval(() => {
                fetch(`/admin/import_progress/${progressId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);
                    
                    // Check if complete
                    if (data.status === 'complete' && data.redirect_url) {
                        console.log('‚úÖ Import completed, redirecting...');
                        clearInterval(progressInterval);
                        window.location.href = data.redirect_url;
                    } else if (data.status === 'error' || data.status === 'no_data') {
                        console.log('üèÅ Import finished with status:', data.status);
                        clearInterval(progressInterval);
                        // Re-enable form for retry
                        document.getElementById('submitBtn').disabled = false;
                        document.getElementById('submitBtn').textContent = 'Start Import';
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error polling progress:', error);
                });
            }, 1000); // Poll every second
        }
        
        function updateProgress(data) {
            console.log(`üìà Progress Update: ${data.message}`);
            console.log(`   Step: ${data.step}/${data.total_steps}`);
            console.log(`   Companionships: ${data.companionships_found}`);
            console.log(`   Members: ${data.members_found}`);
            
            if (data.errors && data.errors.length > 0) {
                console.warn('‚ö†Ô∏è Errors encountered:', data.errors);
            }
            
            // Update UI
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressStats = document.getElementById('progressStats');
            
            const percentage = (data.step / data.total_steps) * 100;
            progressBar.style.width = percentage + '%';
            
            progressMessage.textContent = data.message;
            progressStats.textContent = `Companionships: ${data.companionships_found} | Members: ${data.members_found}`;
            
            if (data.status === 'complete' || data.status === 'error' || data.status === 'no_data') {
                clearInterval(progressInterval);
                console.log('üèÅ Progress monitoring stopped');
            }
        }
        
        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        });
    </script>
</body>
</html>