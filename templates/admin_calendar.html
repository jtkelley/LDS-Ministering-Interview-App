<!DOCTYPE html>
<html>
<head>
    <title>Admin Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; }
        .navbar { background-color: #343a40; color: white; padding: 10px; display: flex; justify-content: flex-start; }
        .navbar a { color: white; text-decoration: none; margin: 0 15px; }
        .navbar a:hover { text-decoration: underline; }
        .content { padding: 20px; }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="{{ url_for('admin') }}">Calendar</a>
        <a href="{{ url_for('manage_districts') }}">Manage Districts</a>
        <a href="{{ url_for('scrape_data') }}">Scrape from LCR</a>
        <a href="{{ url_for('import_csv') }}">Import from CSV</a>
    </div>
    
    <div class="content">
        <h1 class="mb-4">Interview Calendar</h1>
        
        <div class="mb-4">
            <form method="GET" class="d-inline">
                <label for="district" class="form-label me-2">Filter by District:</label>
                <select name="district" id="district" class="form-select d-inline w-auto" onchange="this.form.submit()">
                    <option value="">All Districts</option>
                    {% for district in all_districts %}
                    <option value="{{ district.id }}" {% if district.id == selected_district_id %}selected{% endif %}>{{ district.name }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        
        <div class="row">
        {% for district in districts %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ district.name }}</h5>
                    <small class="text-muted">Interviewer: {{ district.interviewer_name }}</small>
                    <a href="{{ url_for('district_detail', id=district.id) }}" class="btn btn-sm btn-outline-primary float-end">Manage</a>
                </div>
                <div class="card-body">
                    {% set slots = district_slots[district.id] %}
                    {% set slots_by_date = {} %}
                    {% for slot in slots %}
                    {% if slot.date not in slots_by_date %}
                    {% set _ = slots_by_date.update({slot.date: []}) %}
                    {% endif %}
                    {% set _ = slots_by_date[slot.date].append(slot) %}
                    {% endfor %}
                    
                    {% if slots_by_date %}
                    {% for date in slots_by_date | sort %}
                    <div class="mb-3">
                        <h6 class="text-primary">{{ date.strftime('%A, %B %d, %Y') }}</h6>
                        {% for slot in slots_by_date[date] %}
                        <div class="slot mb-2 p-2 border rounded 
                            {% if slot.bookings|length == 0 %}bg-success text-white
                            {% elif slot.bookings|length < 10 %}bg-warning
                            {% else %}bg-danger text-white{% endif %}">
                            <strong>{{ slot.start_time }} ({{ slot.duration }}min)</strong>
                            
                            {% if slot.bookings %}
                            <ul class="list-unstyled mt-1 mb-1 small">
                            {% for booking in slot.bookings %}
                                <li class="d-flex justify-content-between align-items-center">
                                    <span>{{ booking.member.name }} {% if booking.member.phone %}{{ booking.member.phone }}{% endif %}</span>
                                    <form method="POST" action="{{ url_for('remove_booking', booking_id=booking.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-outline-danger btn-close" onclick="return confirm('Remove {{ booking.member.name }}?')" aria-label="Remove"></button>
                                    </form>
                                </li>
                            {% endfor %}
                            </ul>
                            {% endif %}
                            
                            {% if slot.bookings|length < 10 %}
                            {% set booked_ids = slot.bookings|map(attribute='member_id')|list %}
                            {% set allowed_team = slot.bookings[0].member.team if slot.bookings else None %}
                            <form method="POST" action="{{ url_for('add_booking', slot_id=slot.id) }}" class="mt-1">
                                <div class="input-group input-group-sm">
                                    <select name="member_id" class="form-select select2" style="flex: 1;">
                                        <option value="">Add member...</option>
                                        {% if allowed_team %}
                                        {% for member in allowed_team.members %}
                                        {% if member.id not in booked_ids %}
                                        <option value="{{ member.id }}">{{ member.name }}</option>
                                        {% endif %}
                                        {% endfor %}
                                        {% else %}
                                        {% for team in district.teams %}
                                        {% for member in team.members %}
                                        {% if member.id not in booked_ids %}
                                        <option value="{{ member.id }}">{{ member.name }}</option>
                                        {% endif %}
                                        {% endfor %}
                                        {% endfor %}
                                        {% endif %}
                                    </select>
                                    <button type="submit" class="btn btn-primary btn-sm">Add</button>
                                </div>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted small">No upcoming slots.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.select2').select2({
                placeholder: 'Search for member...',
                allowClear: true
            });
        });
    </script>
</body>
</html>